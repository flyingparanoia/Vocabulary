<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿‘ä¹‰è¯æ¯”è¾ƒ</title>
    <!-- TailwindCSS å·²ç§»é™¤ï¼Œå› ä¸ºæ–°æ ·å¼ä¸ä¾èµ–å®ƒ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            /* Dark Theme (Default) */
            --bg: #0f1115; --panel: #161a22; --panel2: #121722; --text: #e6e7ea; --muted: #9aa3b2;
            --border: #242a36; --accent: #7aa2ff; --hl: #2a3b63; --ok: #50fa7b;
            --shadow: rgba(0, 0, 0, 0.2);
            --code-bg: #111826; --code-border: #222a3f;
            --toggle-bg: #162036; --toggle-border: #2b3750; --toggle-text: #cfd8ff;
            --badge-bg: #1a2233; --badge-border: #2b3750; --badge-text: #cdd7ff;
            --tag-bg: #192033; --tag-border: #26304b; --tag-text: #cbd5e1;
            --pill-bg: #172033; --pill-border: #2b3750; --pill-text: #cfe4ff;
            --focus: 0 0 0 3px color-mix(in srgb, var(--accent) 28%, transparent);
            --colW: 384px; /* å¯é€šè¿‡æ»‘å—åŠ¨æ€è°ƒèŠ‚ (é»˜è®¤ 384px) */
            --radius: 12px;
        }

        @media (prefers-color-scheme: light) {
            :root {
                /* Light Theme */
                --bg: #f8f9fa; --panel: #ffffff; --panel2: #f1f3f5; --text: #212529; --muted: #6c757d;
                --border: #dee2e6; --accent: #0d6efd; --hl: #cfe2ff; --ok: #198754;
                --shadow: rgba(0, 0, 0, 0.06);
                --code-bg: #e9ecef; --code-border: #ced4da;
                --toggle-bg: #e9ecef; --toggle-border: #ced4da; --toggle-text: #495057;
                --badge-bg: #e7f5ff; --badge-border: #a5d8ff; --badge-text: #0d6efd;
                --tag-bg: #f1f3f5; --tag-border: #dee2e6; --tag-text: #495057;
                --pill-bg: #e9ecef; --pill-border: #ced4da; --pill-text: #343a40;
            }
        }

        * { box-sizing: border-box; }
        html, body { height: 100%; }
        body {
            margin: 0; background: var(--bg); color: var(--text);
            /* ä½¿ç”¨ Noto Sans SC ä½œä¸ºå¤‡ç”¨ */
            font: 15px/1.6 ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Noto Sans SC", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        /* =================== é¡¶éƒ¨å·¥å…·æ  =================== */
        header {
            position: sticky; top: 0; z-index: 20;
            background: linear-gradient(180deg, color-mix(in srgb, var(--bg) 86%, transparent) 0%, transparent 100%);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid color-mix(in srgb, var(--border) 60%, transparent);
        }
        header .wrap { max-width: 1800px; margin: 0 auto; padding: 14px 16px; }
        header h1 { font-size: 20px; margin: 0 0 8px 0; font-weight: 700; letter-spacing: .3px; }

        /* âœ… ä¿®æ”¹ï¼šè°ƒæ•´å·¥å…·æ å¸ƒå±€ */
        header .toolbar { 
            display: grid; 
            /* å¸ƒå±€ï¼š[ç²˜è´´æŒ‰é’®] [æœç´¢æ¡†(1fr)] [å³ä¾§å·¥å…·ç»„] */
            grid-template-columns: auto 1fr auto; 
            gap: 10px; 
            align-items: center; 
        }
        header .tools { display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end; }

        header input[type="search"] {
            width: 100%; min-width: 200px; /* å‡å°æœ€å°å®½åº¦ */
            padding: 10px 14px; border-radius: 10px;
            border: 1px solid var(--border); background: var(--panel2); color: var(--text); outline: none;
            transition: box-shadow .2s, border-color .2s; box-shadow: none;
        }
        header input[type="search"]:focus { border-color: var(--accent); box-shadow: var(--focus); }

        header .btn {
            padding: 9px 12px; border-radius: 10px; border: 1px solid var(--border);
            background: var(--panel); color: var(--text); cursor: pointer; font-weight: 600; font-size: 13px;
            transition: transform .08s ease, border-color .2s, color .2s, background-color .2s;
            user-select: none; white-space: nowrap;
        }
        header .btn:hover { border-color: var(--accent); color: var(--accent); }
        header .btn:active { transform: translateY(1px); }
        header .btn[data-active="true"] { 
            outline: none; border-color: var(--accent); 
            /* æ¿€æ´»çŠ¶æ€ä½¿ç”¨é«˜äº®è‰² */
            background: var(--hl); color: var(--accent);
        }
        /* âœ… æ–°å¢ï¼šç²˜è´´æŒ‰é’®çš„ç‰¹å®šé«˜äº®ï¼ˆç»¿è‰²ï¼‰*/
        header #pasteData:hover {
             border-color: var(--ok); color: var(--ok);
        }
        header #pasteData {
            background: color-mix(in srgb, var(--ok) 15%, var(--panel));
            border-color: color-mix(in srgb, var(--ok) 50%, var(--border));
        }


        header .seg { display: inline-flex; border: 1px solid var(--border); border-radius: 999px; overflow: hidden; }
        header .seg .btn { border: none; border-right: 1px solid var(--border); border-radius: 0; padding: 8px 12px; }
        header .seg .btn:last-child { border-right: none; }
        header .seg .btn[data-active="true"] {
            background: var(--accent); color: var(--bg); border-color: var(--accent);
        }


        header .slider { display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--panel); }
        header .slider input { accent-color: var(--accent); }
        header .hint { color: var(--muted); font-size: 12px; }
        header #colWidthVal { width: 45px; text-align: right; }

        /* =================== ä¸»åŒºå¸ƒå±€ï¼ˆä¸¤ç§æ¨¡å¼ï¼šæ¨ªå‘è½®æ’­ / è‡ªé€‚åº”ç½‘æ ¼ï¼‰ =================== */
        main {
            max-width: 1800px; margin: 12px auto 80px; padding: 0 16px;
            gap: 24px; align-items: start;
        }

        /* é€‚é…ï¼š vocab-container æ˜¯å¡ç‰‡ç»„çš„å®¹å™¨ */
        /* è½®æ’­æ¨¡å¼ */
        body[data-layout="scroll"] #vocab-container {
            display: flex; overflow-x: auto; gap: 24px; align-items: start;
            scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; scrollbar-width: none; -ms-overflow-style: none;
        }
        body[data-layout="scroll"] #vocab-container::-webkit-scrollbar { display: none; }
        body[data-layout="scroll"] #vocab-container .card { 
            flex: 0 0 var(--colW); 
            scroll-snap-align: start; 
            width: var(--colW);
        }

        /* ç½‘æ ¼æ¨¡å¼ */
        body[data-layout="grid"] #vocab-container { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(min(100%, var(--colW)), 1fr)); 
            gap: 24px;
        }
        body[data-layout="grid"] #vocab-container .card { width: 100%; }


        /* =================== å¡ç‰‡æ ·å¼ =================== */
        .card {
            background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius);
            box-shadow: 0 8px 20px var(--shadow); 
            transition: box-shadow .2s ease, transform .15s ease, border-color .2s;
            overflow: hidden; /* ç¡®ä¿åœ†è§’è£åˆ‡ */
        }
        .card:hover { box-shadow: 0 12px 28px var(--shadow); }
        
        /* æœç´¢é«˜äº®å’Œéšè— */
        .card.highlight {
            border-color: var(--accent);
            box-shadow: 0 8px 24px color-mix(in srgb, var(--accent) 20%, transparent);
        }
        .card.hidden { display: none; }
        
        /* å¡ç‰‡å†…éƒ¨ç»„ä»¶æ ·å¼ */
        .card-header { padding: 20px; border-bottom: 1px solid var(--border); }
        .card-content { padding: 20px; }
        
        /* å¯†åº¦ï¼šç´§å‡‘ / èˆ’é€‚ */
        body[data-density="compact"] .card-header,
        body[data-density="compact"] .card-content { padding: 14px 16px; }
        body[data-density="cozy"] .card-header,
        body[data-density="cozy"] .card-content { padding: 20px 24px; }
        body[data-density="compact"] details > summary { padding: 10px 12px; }
        body[data-density="cozy"] details > summary { padding: 16px; }

        .section-title { font-size: 1.25rem; font-weight: 700; color: var(--text); }
        h2.text-2xl { font-size: 1.5rem; font-weight: 700; color: var(--text); }
        .text-gray-500 { color: var(--muted); }
        
        details > summary {
            cursor: pointer;
            background-color: var(--panel2);
            border-radius: 8px;
            font-weight: 600;
            color: var(--text);
            transition: background-color 0.2s ease;
            list-style: none;
            margin-top: 8px;
        }
        details > summary::-webkit-details-marker { display: none; }
        details > summary::before {
            content: 'â–¶';
            margin-right: 10px;
            font-size: 0.8em;
            transition: transform 0.2s ease-in-out;
        }
        details[open] > summary::before { transform: rotate(90deg); }
        details[open] > summary { background-color: color-mix(in srgb, var(--panel) 80%, var(--panel2)); }
        
        .details-content { 
            padding: 16px; 
            border-top: 1px solid var(--border); 
            margin-top: 8px;
        }
        body[data-density="compact"] .details-content { padding: 12px; }
        
        .pron-btn {
            cursor: pointer; display: inline-flex; align-items: center;
            padding: 4px 8px; border-radius: 6px;
            background-color: var(--panel2);
            border: 1px solid var(--border);
            font-size: 0.9rem; font-weight: 500;
            color: var(--muted);
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        }
        .pron-btn:hover { background-color: var(--hl); border-color: var(--accent); color: var(--accent); }
        
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { border: 1px solid var(--border); padding: 12px; text-align: left; }
        th { background-color: var(--panel2); font-weight: 600; }
        
        .quiz-item { margin-top: 1rem; padding: 1rem; background: var(--panel2); border-radius: 8px; }
        .quiz-option { margin: 0.5rem 0; }
        
        .chip{
            display:inline-block; padding: 2px 8px; border-radius: 999px;
            font-size: 12px; line-height: 1.6; margin-right: 6px;
            color: var(--badge-text); background: var(--badge-bg); border: 1px solid var(--badge-border);
        }
        /* ä¿æŒCEFRé¢œè‰² */
        .chip.cefr-B1{background:#eef2ff;border-color:#c7d2fe;color:#4338ca;}
        .chip.cefr-B2{background:#e0f2fe;border-color:#bae6fd;color:#0369a1;}
        .chip.cefr-C1{background:#f0fdf4;border-color:#bbf7d0;color:#15803d;}
        .chip.cefr-C2{background:#fefce8;border-color:#fde047;color:#854d0e;}
        @media (prefers-color-scheme: dark) {
            .chip.cefr-B1{background:#3730a3;border-color:#4f46e5;color:#e0e7ff;}
            .chip.cefr-B2{background:#0c4a6e;border-color:#0ea5e9;color:#e0f2fe;}
            .chip.cefr-C1{background:#166534;border-color:#22c55e;color:#dcfce7;}
            .chip.cefr-C2{background:#713f12;border-color:#eab308;color:#fefce8;}
        }

        /* æ‹–æ‹½å ä½ */
        .sortable-ghost { 
            opacity: 0.4; 
            background: var(--hl); 
            border: 2px dashed var(--accent);
            border-radius: var(--radius);
        }
        .card-draggable { cursor: grab; }
        .card-draggable:active { cursor: grabbing; }

        /* æ€»è¡¨æ ·å¼ */
        #summary-container .card {
             background: var(--panel);
        }
        #summary-container .section-title {
            padding: 10px 0;
            color: var(--text);
        }
        #summary-container details > summary {
            background: var(--panel);
        }
        #summary-container details[open] > summary {
             background: var(--panel);
        }
        #summary-container .details-content {
            padding: 0;
            border-top: none;
        }
        #summary-container table {
            margin-top: 0;
            border: none;
        }
         #summary-container th, #summary-container td {
            border-color: var(--border);
         }
         #summary-container th {
            background-color: var(--panel2);
            color: var(--text);
         }
         #summary-container tr:nth-child(even) {
            background-color: var(--panel2);
         }
         #summary-container tr:nth-child(odd) {
            background-color: var(--panel);
         }
        
        /* å“åº”å¼ï¼šè°ƒæ•´å·¥å…·æ å¸ƒå±€ */
        @media (max-width: 1200px) {
            header .toolbar {
                grid-template-columns: 1fr auto; /* æœç´¢æ¡†åœ¨ç¬¬ä¸€è¡Œ */
                gap: 12px;
            }
            header .toolbar input[type="search"] {
                grid-column: 1 / 2; /* æœç´¢æ¡†å æ»¡ç¬¬ä¸€è¡Œ */
            }
            header .toolbar #pasteData {
                grid-column: 1 / 2; /* ç²˜è´´æŒ‰é’®ä¹Ÿæ”¾åœ¨ç¬¬ä¸€è¡Œ */
                grid-row: 1;
                width: auto; /* ä¿æŒæŒ‰é’®å®½åº¦ */
            }
             header .toolbar input[type="search"] {
                grid-column: 2 / 3; /* æœç´¢æ¡†æ”¾åœ¨ç¬¬ä¸€è¡Œç¬¬äºŒåˆ— */
                grid-row: 1;
            }
            header .tools {
                grid-column: 1 / 3; /* å·¥å…·ç»„å æ»¡ç¬¬äºŒè¡Œ */
                grid-row: 2;
                justify-content: flex-start; /* å·¦å¯¹é½ */
            }
        }
         @media (max-width: 560px) {
             header .toolbar {
                grid-template-columns: 1fr; /* å•åˆ—å¸ƒå±€ */
             }
             header .toolbar #pasteData {
                grid-column: 1;
                grid-row: 1;
             }
             header .toolbar input[type="search"] {
                grid-column: 1;
                grid-row: 2;
             }
             header .tools {
                grid-column: 1;
                grid-row: 3;
             }
         }


        /* æ‰“å°æ ·å¼ */
        @media print{
            body{ background:#fff; font-size: 10pt; color: #000; }
            header { display: none !important; }
            .card{ box-shadow:none; border:1px solid #dee2e6; page-break-inside: avoid; background: #fff; }
            details{ border:none; }
            details[open] { page-break-inside: avoid; }
            summary::before { display: none; }
            .pron-btn, footer, script, #summary-container { display:none !important; }
            #vocab-container { display: block; } 
            body[data-layout="grid"] #vocab-container { display: block; }
            #vocab-container .card { width: 100% !important; }
            h1, h2, h3 { font-size: 1.2em; color: #000; }
            a { text-decoration: none; color: black; }
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000; opacity: 0; transition: opacity .2s; pointer-events: none;
        }
        .modal-overlay[data-visible="true"] { opacity: 1; pointer-events: auto; }
        .modal-content {
            background: var(--panel); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 24px 30px;
            max-width: 400px; width: 90%;
            box-shadow: 0 10px 30px var(--shadow);
            transform: scale(0.95); transition: transform .2s;
        }
        .modal-overlay[data-visible="true"] .modal-content { transform: scale(1); }
        .modal-content h3 { margin-top: 0; color: var(--accent); }
        .modal-content p { color: var(--text); }
        .modal-content #closeErrorModal { 
            margin-top: 20px; 
            background: var(--accent); 
            color: var(--bg); 
            border-color: var(--accent); 
            width: 100%;
            padding: 10px;
            font-weight: 700;
            border-radius: 8px;
            cursor: pointer;
        }
        .modal-content #closeErrorModal:hover { background: color-mix(in srgb, var(--accent) 80%, white); }
    </style>
</head>
<!-- âœ… ä¿®æ”¹ï¼šé»˜è®¤ä½¿ç”¨ data- å±æ€§ -->
<body data-layout="scroll" data-density="compact">

    <!-- âœ… æ–°å¢ï¼šæ›¿æ¢ä¸ºæ–° Header -->
    <header>
      <div class="wrap">
        <h1>è¿‘ä¹‰è¯æ¯”è¾ƒ</h1>
        <div class="toolbar">
          <!-- âœ… ä¿®æ”¹ï¼šç²˜è´´æŒ‰é’®ç§»åˆ°æœ€å·¦ä¾§ -->
          <button class="btn" id="pasteData" title="ä»å‰ªè´´æ¿ç²˜è´´æ–°çš„è¯æ±‡æ•°æ®">ğŸ“‹ ç²˜è´´æ•°æ®</button>
          
          <input id="q" type="search" placeholder="ğŸ” æœç´¢è¯æ±‡ (ä¾‹å¦‚: lucid)" aria-label="æœç´¢è¯æ±‡">
          
          <div class="tools" role="group" aria-label="è§†å›¾ä¸æ“ä½œ">
            <div class="seg" aria-label="å¸ƒå±€åˆ‡æ¢">
              <button class="btn" id="btnGrid" title="è‡ªé€‚åº”ç½‘æ ¼">ç½‘æ ¼</button>
              <button class="btn" id="btnScroll" data-active="true" title="æ¨ªå‘è½®æ’­">è½®æ’­</button>
            </div>
            <div class="seg" aria-label="å¯†åº¦åˆ‡æ¢">
              <button class="btn" id="btnCozy" title="èˆ’é€‚">èˆ’é€‚</button>
              <button class="btn" id="btnCompact" data-active="true" title="ç´§å‡‘">ç´§å‡‘</button>
            </div>
            <div class="slider" title="åˆ—å®½">
              <span class="hint">åˆ—å®½</span>
              <input id="colWidth" type="range" min="320" max="640" step="10" value="384">
              <span id="colWidthVal" class="hint">384px</span>
            </div>
            <button class="btn" id="toggleDrag" title="æ‹–æ‹½é‡æ’ï¼ˆå¼€å¯åå¯æ‹–åŠ¨æ¯ä¸€åˆ—è¿›è¡Œæ’åºï¼‰">æ‹–æ‹½å…³</button>
            <button class="btn" id="expandAll" title="å±•å¼€å…¨éƒ¨">å…¨éƒ¨å±•å¼€</button>
            <button class="btn" id="collapseAll" title="æŠ˜å å…¨éƒ¨">å…¨éƒ¨æŠ˜å </button>
            <!-- âœ… æ–°å¢ï¼šè¯æ ¹æ¯”è¾ƒæŒ‰é’® -->
            <a href="https://flyingparanoia.github.io/Vocabulary/" target="_blank" class="btn" title="è·³è½¬åˆ°è¯æ ¹æ¯”è¾ƒå·¥å…·" style="text-decoration: none;">è¯æ ¹æ¯”è¾ƒ</a>
          </div>
        </div>
      </div>
    </header>
    <!-- âœ… Header ç»“æŸ -->

    <!-- âœ… ä¿®æ”¹ï¼šä½¿ç”¨ <main> æ ‡ç­¾ -->
    <main>
        <!-- âœ… æ–°å¢ï¼šé”™è¯¯ä¿¡æ¯æç¤ºæ¡† (Modal) -->
        <div id="errorModal" class="modal-overlay" data-visible="false">
            <div class="modal-content">
                <h3></h3>
                <p id="errorMessage"></p>
                <button id="closeErrorModal">å…³é—­</button>
            </div>
        </div>
        
        <div id="summary-container" class="mb-6">
            <!-- Summary table will be injected here -->
        </div>

        <div id="vocab-container">
            <!-- Vocabulary cards will be injected here by JavaScript -->
        </div>

        <footer class="mt-12 text-center text-sm" style="color: var(--muted); margin-top: 3rem;">
             <div class="card" style="background: var(--panel); border-color: var(--border);">
                 <div class="card-content">
                     <h3 class="section-title" style="color: var(--text);">ğŸ”š å¼•ç”¨ä¸å¯é æ€§è¯´æ˜</h3>
                     <p class="mb-2" style="margin-bottom: 0.5rem;"><strong>å‚è€ƒè¯å…¸ï¼š</strong></p>
                     <ul class="list-disc list-inside mb-4" style="list-style-type: disc; padding-left: 1.25rem; margin-bottom: 1rem;">
                         <li>Oxford English Dictionary (OED)</li>
                         <li>Merriam-Webster Collegiate Dictionary</li>
                         <li>Cambridge Advanced Learner's Dictionary</li>
                     </ul>
                     <p class="mb-2" style="margin-bottom: 0.5rem;"><strong>æ–‡æœ¬æ¥æºï¼š</strong></p>
                     <ul class="list-disc list-inside" style="list-style-type: disc; padding-left: 1.25rem;">
                         <li>å½±è§†ä¾‹å¥ä¸»è¦æ¥æºäº IMDbã€Subzin ç­‰å…¬å¼€æ•°æ®åº“ï¼Œå¹¶ç»è¿‡è¯­å¢ƒæ ¸å®ã€‚</li>
                         <li>æ–‡å­¦ä¾‹å¥æ¥æºäº Project Gutenberg åŠå…¶ä»–å…¬å…±é¢†åŸŸæ–‡å­¦ä½œå“åº“ã€‚</li>
                         <li>æ‰€æœ‰ä¾‹å¥ä¸æ­é…å‡ç»è¿‡è¯­æ–™åº“ï¼ˆå¦‚ COCA, BNCï¼‰äº¤å‰éªŒè¯ï¼Œç¡®ä¿å…¶å…¸å‹æ€§ä¸å‡†ç¡®æ€§ã€‚</li>
                     </ul>
                 </div>
             </div>
        </footer>
    </main>

    <script>
        const summaryContainer = document.getElementById('summary-container');
        const container = document.getElementById('vocab-container');
        
        // âœ… ä¿®æ”¹ï¼šè·å–æ–° Header ä¸­çš„å…ƒç´ 
        const pasteButton = document.getElementById('pasteData');
        const searchInput = document.getElementById('q');
        const btnGrid = document.getElementById('btnGrid');
        const btnScroll = document.getElementById('btnScroll');
        const btnCozy = document.getElementById('btnCozy');
        const btnCompact = document.getElementById('btnCompact');
        const colWidthSlider = document.getElementById('colWidth');
        const colWidthVal = document.getElementById('colWidthVal');
        const toggleDragBtn = document.getElementById('toggleDrag');
        const expandAllBtn = document.getElementById('expandAll');
        const collapseAllBtn = document.getElementById('collapseAll');
        
        // âœ… ä¿®æ”¹ï¼šè·å– Modal å…ƒç´ 
        const errorModal = document.getElementById('errorModal');
        const errorMessage = document.getElementById('errorMessage');
        const errorModalTitle = errorModal.querySelector('h3');
        const closeErrorModalBtn = document.getElementById('closeErrorModal');

        let sortableInstance = null; // âœ… ç”¨äºä¿å­˜ Sortable å®ä¾‹

        // âœ… æ–°å¢ï¼šæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message, title = "åŠ è½½å¤±è´¥") {
            errorMessage.textContent = message;
            errorModalTitle.textContent = title;
            errorModal.dataset.visible = 'true';
        }
        // âœ… æ–°å¢ï¼šéšè—é”™è¯¯ä¿¡æ¯
        function clearError() {
            errorModal.dataset.visible = 'false';
        }
        // âœ… æ–°å¢ï¼šå…³é—­ Modal
        closeErrorModalBtn.addEventListener('click', clearError);
        errorModal.addEventListener('click', (e) => {
            if (e.target === errorModal) {
                clearError();
            }
        });


        // ... ç°æœ‰çš„ createFullComparisonTable, createQuiz, renderCard, playSound å‡½æ•° ...
        const createFullComparisonTable = (allWords) => {
            // ... (å‡½æ•°å†…å®¹ä¸å˜) ...
            const comparisonItems = allWords.flatMap(wordData => wordData.analysis.comparison);
            let tableHTML = `<div style="overflow-x: auto;"><table style="min-width: 100%;">
                <thead>
                    <tr>
                        <th>å•è¯</th>
                        <th>åŸºæœ¬ä¹‰</th>
                        <th>å…¸å‹è¯­å¢ƒ</th>
                        <th style="display: none;" class="md:table-cell">æ–‡ä½“è‰²å½©</th>
                        <th>å¸¸è§æ­é…</th>
                        <th style="display: none;" class="lg:table-cell">æ˜“æ··ç‚¹è¯´æ˜</th>
                    </tr>
                </thead>
                <tbody>`;
            comparisonItems.forEach(item => {
                tableHTML += `<tr>
                    <td style="font-weight: 600;">${item.word}</td>
                    <td>${item.meaning}</td>
                    <td>${item.context}</td>
                    <td style="display: none;" class="md:table-cell">${item.color}</td>
                    <td>${item.collocations}</td>
                    <td style="display: none;" class="lg:table-cell">${item.notes}</td>
                </tr>`;
            });
            tableHTML += `</tbody></table></div>`;
            
            // è¾…åŠ©åª’ä½“æŸ¥è¯¢çš„å†…è”è„šæœ¬
            tableHTML += `
                <style>
                    @media (min-width: 768px) { .md\:table-cell { display: table-cell !important; } }
                    @media (min-width: 1024px) { .lg\:table-cell { display: table-cell !important; } }
                </style>
            `;
            
            return tableHTML;
        };

        const createQuiz = (quizItems, word) => {
             // ... (å‡½æ•°å†…å®¹ä¸å˜) ...
             return quizItems.map((item, index) => `
                <div class="quiz-item">
                    <p style="font-weight: 600;"><strong>Q${index + 1}.</strong> ${item.q}</p>
                    <p class="text-sm" style="color: var(--muted); font-size: 0.9rem;">${item.t}</p>
                    <div style="margin-top: 0.5rem; margin-bottom: 0.5rem; font-size: 0.9rem;">
                        ${item.o.map(opt => `<label class="block quiz-option" style="display: block; margin-top: 0.5rem; margin-bottom: 0.5rem;"><input type="radio" name="quiz-${word}-${index}" value="${opt}" style="margin-right: 0.5rem;">${opt}</label>`).join('')}
                    </div>
                    <details class="text-sm" style="font-size: 0.9rem;">
                        <summary style="background: var(--panel); border: 1px solid var(--border); color: var(--accent); padding: 8px 12px; font-weight: 500; border-radius: 8px;">æŸ¥çœ‹ç­”æ¡ˆä¸è§£æ</summary>
                        <div class="details-content" style="background: var(--panel); border-top: none; margin-top: 0; border-radius: 0 0 8px 8px;">
                            <p>âœ… <strong>ç­”æ¡ˆï¼š</strong> ${item.a}</p>
                            <p><strong>è§£æï¼š</strong> ${item.r}</p>
                        </div>
                    </details>
                </div>`).join('');
        };

        const renderCard = (item) => {
            // ... (å‡½æ•°å†…å®¹ä¸å˜, ç§»é™¤ Tailwind ç±») ...
            const { word, ipa_uk, ipa_us, analysis } = item;
            return `
                <div class="card card-draggable" id="${word}" data-word="${word.toLowerCase()}">
                    <div class="card-header">
                        <h2 class="text-2xl">${word}</h2>
                        <div class="flex items-center space-x-4 mt-2 text-gray-500 text-sm" style="display: flex; gap: 1rem; margin-top: 0.5rem; font-size: 0.875rem;">
                            <div><span style="font-weight: 700;">ğŸ‡¬ğŸ‡§</span> ${ipa_uk}</div>
                            <div><span style="font-weight: 700;">ğŸ‡ºğŸ‡¸</span> ${ipa_us}</div>
                        </div>
                        <div class="mt-3" style="margin-top: 0.75rem;">
                          <span class="chip cefr-${analysis.quick_look.cefr}">CEFR ${analysis.quick_look.cefr}</span>
                          <span class="chip">${analysis.quick_look.pos}</span>
                          <span class="chip">${analysis.quick_look.style}</span>
                        </div>
                         <div class="flex items-center space-x-2 mt-3" style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
                             <button onclick="playSound('${word}', 'uk')" class="pron-btn" aria-label="æ’­æ”¾è‹±éŸ³ï¼š${word}">ğŸ‡¬ğŸ‡§ è‹±éŸ³ ğŸ”ˆ</button>
                             <button onclick="playSound('${word}', 'us')" class="pron-btn" aria-label="æ’­æ”¾ç¾éŸ³ï¼š${word}">ğŸ‡ºğŸ‡¸ ç¾éŸ³ ğŸ”ˆ</button>
                         </div>
                    </div>
                    <div class="card-content space-y-3" style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <details open>
                            <summary>ğŸŸ¦ ã€è¯æ±‡é€Ÿè§ˆå¡ã€‘</summary>
                            <div class="details-content">
                                <ul class="list-disc list-inside space-y-1" style="list-style-type: disc; padding-left: 1.25rem; display: flex; flex-direction: column; gap: 0.25rem; font-size: 0.9rem;">
                                    <li><strong>æ ¸å¿ƒä¹‰:</strong> ${analysis.quick_look.meaning}</li>
                                    <li><strong>å¸¸è§æ­é…:</strong> ${analysis.quick_look.collocations}</li>
                                </ul>
                            </div>
                        </details>
                        <details open>
                            <summary>ğŸŸ© ã€æ„è¯ä¸è¯æºã€‘</summary>
                             <div class="details-content text-sm space-y-1" style="font-size: 0.9rem; display: flex; flex-direction: column; gap: 0.25rem;">
                                 <p><strong>æ¼”å˜:</strong> ${analysis.etymology.path}</p>
                                 <p><strong>åˆ†æ:</strong> ${analysis.etymology.breakdown}</p>
                                 <p><strong>åŒæº:</strong> ${analysis.etymology.cognates}</p>
                             </div>
                        </details>
                        <details open>
                            <summary>ğŸŸ¥ ã€å½±è§†ä¸æ–‡å­¦ä¾‹è¯ã€‘</summary>
                            <div class="details-content space-y-4" style="display: flex; flex-direction: column; gap: 1rem;">
                                ${analysis.examples.map(ex => `
                                    <figure class="p-3" style="background: var(--panel2); border-radius: 8px; padding: 0.75rem;">
                                        <blockquote class="pl-4 border-l-4" style="padding-left: 1rem; border-left: 4px solid var(--border); margin: 0.25rem 0; font-size: 0.9rem;">
                                            <p style="font-style: italic;">"${ex.sentence}"</p>
                                            <p>"${ex.translation}"</p>
                                        </blockquote>
                                        <figcaption class="text-xs mt-2" style="font-size: 0.8rem; color: var(--muted); margin-top: 0.5rem;">
                                          â€” ${ex.type === 'movie' ? 'ğŸ¬' : 'ğŸ“–'} <em style="font-style: italic;">${ex.source}</em>
                                          <p class="mt-1" style="margin-top: 0.25rem;"><strong>è¯­å¢ƒ:</strong> ${ex.context}</p>
                                        </figcaption>
                                    </figure>
                                `).join('')}
                            </div>
                        </details>
                        <details open>
                            <summary>ğŸŸ« ã€å…¸å‹æ­é…ä¸è¯­å—ã€‘</summary>
                             <div class="details-content">
                                 <ul class="list-disc list-inside space-y-1" style="list-style-type: disc; padding-left: 1.25rem; display: flex; flex-direction: column; gap: 0.25rem; font-size: 0.9rem;">
                                     ${analysis.collocations_list.map(c => `<li>${c}</li>`).join('')}
                                 </ul>
                             </div>
                        </details>
                        <details open>
                            <summary>â¬œ ã€æ˜“æ··ä¸è¾¹ç•Œè¯ã€‘</summary>
                            <div class="details-content text-sm" style="font-size: 0.9rem;"><p>${analysis.contrast.text}</p></div>
                        </details>
                        <details open>
                            <summary>ğŸŸ© ã€å°ç»ƒä¹ é¢˜ã€‘</summary>
                             <div class="details-content">${createQuiz(analysis.quiz, word)}</div>
                        </details>
                    </div>
                </div>
            `;
        };

        function playSound(word, region) {
            // ... (å‡½æ•°å†…å®¹ä¸å˜) ...
            const lang = region === 'uk' ? 'en-GB' : 'en-US';
            const url = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(word)}&tl=${lang}&client=tw-ob`;
            const audio = new Audio(url);
            audio.play().catch(error => {
                console.error("Audio playback failed:", error)
                showError('éŸ³é¢‘æ’­æ”¾å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ–æµè§ˆå™¨é™åˆ¶ã€‚', 'æ’­æ”¾å¤±è´¥');
            });
        }
        
        function initializeVocabularyApp(vocabularyData) {
            if (!Array.isArray(vocabularyData) || vocabularyData.length === 0) {
                showError('æ•°æ®æ ¼å¼ä¸æ­£ç¡®æˆ–ä¸ºç©ºã€‚');
                return;
            }
            
            summaryContainer.innerHTML = '';
            container.innerHTML = '';
            clearError();

            try {
                // 1. æ¸²æŸ“æ€»è¡¨
                const fullComparisonSection = `
                    <div class="card" style="margin-bottom: 24px;">
                        <div class="card-content">
                            <details open>
                                <summary class="section-title">ğŸŸ¨ ã€æ‰€æœ‰è¯æ±‡è¯­ä¹‰å¯¹æ¯”æ€»è¡¨ã€‘</summary>
                                <div class="details-content">
                                    ${createFullComparisonTable(vocabularyData)}
                                </div>
                            </details>
                        </div>
                    </div>`;
                summaryContainer.innerHTML = fullComparisonSection;

                // 2. æ¸²æŸ“æ‰€æœ‰å¡ç‰‡
                const allCardsHTML = vocabularyData.map(renderCard).join('');
                container.innerHTML = allCardsHTML;

                // 3. åˆå§‹åŒ– SortableJS
                if (sortableInstance) {
                    sortableInstance.destroy();
                }
                sortableInstance = new Sortable(container, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    draggable: '.card-draggable', // ç¡®ä¿åªæ‹–åŠ¨å¡ç‰‡
                    disabled: true, // âœ… é»˜è®¤ç¦ç”¨
                });
                
                // 4. æ›´æ–°æ‹–åŠ¨æŒ‰é’®çš„åˆå§‹çŠ¶æ€
                toggleDragBtn.textContent = 'æ‹–æ‹½å…³';
                toggleDragBtn.dataset.active = 'false';

            } catch (error) {
                console.error("Error rendering vocabulary app:", error);
                showError(`æ¸²æŸ“æ—¶å‡ºé”™: ${error.message}`, 'æ¸²æŸ“å¤±è´¥');
            }
        }

        // âœ… ä¿®æ”¹ï¼šä¸ºâ€œç²˜è´´â€æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        pasteButton.addEventListener('click', async () => {
            try {
                const text = await navigator.clipboard.readText();
                if (!text) {
                    showError('å‰ªè´´æ¿ä¸ºç©ºã€‚');
                    return;
                }
                try {
                    const data = JSON.parse(text);
                    initializeVocabularyApp(data);
                } catch (jsonError) {
                    console.error("Invalid JSON:", jsonError);
                    showError(`JSON æ ¼å¼æ— æ•ˆã€‚è¯·ç¡®ä¿ç²˜è´´çš„æ˜¯æ­£ç¡®çš„ JSON æ•°ç»„ã€‚ ${jsonError.message}`);
                    summaryContainer.innerHTML = '';
                    container.innerHTML = '';
                }
            } catch (clipboardError) {
                console.error("Clipboard read failed:", clipboardError);
                showError('æ— æ³•è¯»å–å‰ªè´´æ¿ã€‚è¯·ç¡®ä¿å·²æˆäºˆæµè§ˆå™¨å‰ªè´´æ¿æƒé™ã€‚', 'æƒé™ä¸è¶³');
            }
        });
        
        // âœ… æ–°å¢ï¼šä¸ºæ–°å·¥å…·æ æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨

        // æœç´¢
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase().trim();
            const cards = document.querySelectorAll('#vocab-container .card');
            cards.forEach(card => {
                const word = card.dataset.word || '';
                // æœç´¢å¡ç‰‡å†…çš„æ‰€æœ‰æ–‡æœ¬å†…å®¹
                const cardText = card.textContent || card.innerText;
                const isMatch = word.includes(query) || cardText.toLowerCase().includes(query);
                card.classList.toggle('hidden', !isMatch); // éšè—ä¸åŒ¹é…çš„
                card.classList.toggle('highlight', query && isMatch); // é«˜äº®åŒ¹é…çš„
            });
        });

        // å¸ƒå±€åˆ‡æ¢
        btnGrid.addEventListener('click', () => {
            document.body.dataset.layout = 'grid';
            btnGrid.dataset.active = 'true';
            btnScroll.dataset.active = 'false';
        });
        btnScroll.addEventListener('click', () => {
            document.body.dataset.layout = 'scroll';
            btnScroll.dataset.active = 'true';
            btnGrid.dataset.active = 'false';
        });

        // å¯†åº¦åˆ‡æ¢
        btnCozy.addEventListener('click', () => {
            document.body.dataset.density = 'cozy';
            btnCozy.dataset.active = 'true';
            btnCompact.dataset.active = 'false';
        });
        btnCompact.addEventListener('click', () => {
            document.body.dataset.density = 'compact';
            btnCompact.dataset.active = 'true';
            btnCozy.dataset.active = 'false';
        });

        // åˆ—å®½æ»‘å—
        colWidthSlider.addEventListener('input', (e) => {
            const width = e.target.value;
            document.documentElement.style.setProperty('--colW', `${width}px`);
            colWidthVal.textContent = `${width}px`;
        });
        // åˆå§‹åŒ–æ»‘å—å€¼
        (function() {
             const initialWidth = colWidthSlider.value;
             document.documentElement.style.setProperty('--colW', `${initialWidth}px`);
             colWidthVal.textContent = `${initialWidth}px`;
        })();


        // æ‹–æ‹½å¼€å…³
        toggleDragBtn.addEventListener('click', () => {
            if (!sortableInstance) {
                showError('è¯·å…ˆç²˜è´´æ•°æ®ä»¥åŠ è½½å¡ç‰‡ã€‚', 'æ— å†…å®¹');
                return;
            }
            const isDisabled = sortableInstance.option('disabled');
            sortableInstance.option('disabled', !isDisabled);
            
            if (isDisabled) { // å³å°†å˜ä¸º "å¯ç”¨"
                toggleDragBtn.textContent = 'æ‹–æ‹½å¼€';
                toggleDragBtn.dataset.active = 'true';
            } else { // å³å°†å˜ä¸º "ç¦ç”¨"
                toggleDragBtn.textContent = 'æ‹–æ‹½å…³';
                toggleDragBtn.dataset.active = 'false';
            }
        });

        // æŠ˜å /å±•å¼€
        expandAllBtn.addEventListener('click', () => {
            document.querySelectorAll('details').forEach(detail => detail.open = true);
        });
        collapseAllBtn.addEventListener('click', () => {
            document.querySelectorAll('details').forEach(detail => detail.open = false);
        });

    </script>
</body>
</html>
