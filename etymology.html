<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>è¿‘ä¹‰è¯æ ¹æ¯”è¾ƒ</title>
<style>
        :root {
            /* Dark Theme (Default) */
            --bg: #0f1115; --panel: #161a22; --panel2: #121722; --text: #e6e7ea; --muted: #9aa3b2;
            --border: #242a36; --accent: #7aa2ff; --hl: #2a3b63; --ok: #50fa7b;
            --shadow: rgba(0, 0, 0, 0.2);
            --code-bg: #111826; --code-border: #222a3f;
            --toggle-bg: #162036; --toggle-border: #2b3750; --toggle-text: #cfd8ff;
            --badge-bg: #1a2233; --badge-border: #2b3750; --badge-text: #cdd7ff;
            --tag-bg: #192033; --tag-border: #26304b; --tag-text: #cbd5e1;
            --pill-bg: #172033; --pill-border: #2b3750; --pill-text: #cfe4ff;
            --focus: 0 0 0 3px color-mix(in srgb, var(--accent) 28%, transparent);
            --colW: 384px; /* å¯é€šè¿‡æ»‘å—åŠ¨æ€è°ƒèŠ‚ (é»˜è®¤ 384px) */
            --radius: 12px;
        }

        @media (prefers-color-scheme: light) {
            :root {
                /* Light Theme */
                --bg: #f8f9fa; --panel: #ffffff; --panel2: #f1f3f5; --text: #212529; --muted: #6c757d;
                --border: #dee2e6; --accent: #0d6efd; --hl: #cfe2ff; --ok: #198754;
                --shadow: rgba(0, 0, 0, 0.06);
                --code-bg: #e9ecef; --code-border: #ced4da;
                --toggle-bg: #e9ecef; --toggle-border: #ced4da; --toggle-text: #495057;
                --badge-bg: #e7f5ff; --badge-border: #a5d8ff; --badge-text: #0d6efd;
                --tag-bg: #f1f3f5; --tag-border: #dee2e6; --tag-text: #495057;
                --pill-bg: #e9ecef; --pill-border: #ced4da; --pill-text: #343a40;
            }
        }

        * { box-sizing: border-box; }
        html, body { height: 100%; }
        body {
            margin: 0; background: var(--bg); color: var(--text);
            /* ä½¿ç”¨ Noto Sans SC ä½œä¸ºå¤‡ç”¨ */
            font: 15px/1.6 ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Noto Sans SC", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        /* =================== é¡¶éƒ¨å·¥å…·æ  =================== */
        header {
            position: sticky; top: 0; z-index: 20;
            background: linear-gradient(180deg, color-mix(in srgb, var(--bg) 86%, transparent) 0%, transparent 100%);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid color-mix(in srgb, var(--border) 60%, transparent);
        }
        header .wrap { max-width: 1800px; margin: 0 auto; padding: 14px 16px; }
        header h1 { font-size: 20px; margin: 0 0 8px 0; font-weight: 700; letter-spacing: .3px; }

        /* æ›´æ–° grid å¸ƒå±€ä¸ºä¸‰åˆ—ï¼šæŒ‰é’®, æœç´¢æ¡†, å·¥å…·ç»„ */
        header .toolbar { display: grid; grid-template-columns: auto 1fr auto; gap: 10px; align-items: center; }
        header .tools { display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end; }

        header input[type="search"] {
            width: 100%; min-width: 240px; padding: 10px 14px; border-radius: 10px;
            border: 1px solid var(--border); background: var(--panel2); color: var(--text); outline: none;
            transition: box-shadow .2s, border-color .2s; box-shadow: none;
        }
        header input[type="search"]:focus { border-color: var(--accent); box-shadow: var(--focus); }

        header .btn {
            padding: 9px 12px; border-radius: 10px; border: 1px solid var(--border);
            background: var(--panel); color: var(--text); cursor: pointer; font-weight: 600; font-size: 13px;
            transition: transform .08s ease, border-color .2s, color .2s, background-color .2s;
            user-select: none; white-space: nowrap;
        }
        header .btn:hover { border-color: var(--accent); color: var(--accent); }
        header .btn:active { transform: translateY(1px); }
        header .btn[data-active="true"] { 
            outline: none; border-color: var(--accent); 
            /* æ¿€æ´»çŠ¶æ€ä½¿ç”¨é«˜äº®è‰² */
            background: var(--hl); color: var(--accent);
        }

        header .seg { display: inline-flex; border: 1px solid var(--border); border-radius: 999px; overflow: hidden; }
        header .seg .btn { border: none; border-right: 1px solid var(--border); border-radius: 0; padding: 8px 12px; }
        header .seg .btn:last-child { border-right: none; }
        header .seg .btn[data-active="true"] {
            background: var(--accent); color: var(--bg); border-color: var(--accent);
        }


        header .slider { display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--panel); }
        header .slider input { accent-color: var(--accent); }
        header .hint { color: var(--muted); font-size: 12px; }
        header #colWidthVal { width: 45px; text-align: right; }

        /* =================== ä¸»åŒºå¸ƒå±€ï¼ˆä¸¤ç§æ¨¡å¼ï¼šæ¨ªå‘è½®æ’­ / è‡ªé€‚åº”ç½‘æ ¼ï¼‰ =================== */
        main {
            max-width: 1800px; margin: 12px auto 80px; padding: 0 16px;
            gap: 24px; align-items: start;
        }

        /* é€‚é…ï¼š vocab-container æ˜¯å¡ç‰‡ç»„çš„å®¹å™¨ */
        /* è½®æ’­æ¨¡å¼ */
        body[data-layout="scroll"] #vocab-container {
            display: flex; overflow-x: auto; gap: 24px; align-items: start;
            scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; scrollbar-width: none; -ms-overflow-style: none;
        }
        body[data-layout="scroll"] #vocab-container::-webkit-scrollbar { display: none; }
        body[data-layout="scroll"] #vocab-container .card { 
            flex: 0 0 var(--colW); 
            scroll-snap-align: start; 
            width: var(--colW);
        }

        /* ç½‘æ ¼æ¨¡å¼ */
        body[data-layout="grid"] #vocab-container { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(min(100%, var(--colW)), 1fr)); 
            gap: 24px;
        }
        body[data-layout="grid"] #vocab-container .card { width: 100%; }


        /* =================== å¡ç‰‡æ ·å¼ =================== */
        .card {
            background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius);
            box-shadow: 0 8px 20px var(--shadow); 
            transition: box-shadow .2s ease, transform .15s ease, border-color .2s;
            overflow: hidden; /* ç¡®ä¿åœ†è§’è£åˆ‡ */
        }
        .card:hover { box-shadow: 0 12px 28px var(--shadow); }
        
        /* æœç´¢é«˜äº®å’Œéšè— */
        .card.highlight {
            border-color: var(--accent);
            box-shadow: 0 8px 24px color-mix(in srgb, var(--accent) 20%, transparent);
        }
        .card.hidden { display: none; }
        
        /* å¡ç‰‡å†…éƒ¨ç»„ä»¶æ ·å¼ */
        .card-header { padding: 20px; border-bottom: 1px solid var(--border); }
        .card-content { padding: 20px; }
        
        /* å¯†åº¦ï¼šç´§å‡‘ / èˆ’é€‚ */
        body[data-density="compact"] .card-header,
        body[data-density="compact"] .card-content { padding: 14px 16px; }
        body[data-density="cozy"] .card-header,
        body[data-density="cozy"] .card-content { padding: 20px 24px; }
        
        /* --- é€‚é… tree --- */
        body[data-density="compact"] .tree details > summary { padding: 10px 12px; }
        body[data-density="cozy"] .tree details > summary { padding: 16px; }
        /* --- é€‚é… meta-grid --- */
        body[data-density="compact"] .details-content { padding: 12px; }
        body[data-density="cozy"] .details-content { padding: 16px; }

        .section-title { font-size: 1.25rem; font-weight: 700; color: var(--text); }
        h2.text-2xl { font-size: 1.5rem; font-weight: 700; color: var(--text); }
        .text-gray-500 { color: var(--muted); }
        
        details > summary {
            cursor: pointer;
            background-color: var(--panel2);
            border-radius: 8px;
            font-weight: 600;
            color: var(--text);
            transition: background-color 0.2s ease;
            list-style: none;
            margin-top: 8px;
        }
        details > summary::-webkit-details-marker { display: none; }
        details > summary::before {
            content: 'â–¶';
            margin-right: 10px;
            font-size: 0.8em;
            transition: transform 0.2s ease-in-out;
            display: inline-block; /* ç¡®ä¿ transform ç”Ÿæ•ˆ */
        }
        details[open] > summary::before { transform: rotate(90deg); }
        details[open] > summary { background-color: color-mix(in srgb, var(--panel) 80%, var(--panel2)); }
        
        .details-content { 
            padding: 16px; 
            border-top: 1px solid var(--border); 
            margin-top: 8px;
        }
        
        .pron-btn {
            cursor: pointer; display: inline-flex; align-items: center;
            padding: 4px 8px; border-radius: 6px;
            background-color: var(--panel2);
            border: 1px solid var(--border);
            font-size: 0.9rem; font-weight: 500;
            color: var(--muted);
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        }
        .pron-btn:hover { background-color: var(--hl); border-color: var(--accent); color: var(--accent); }
        
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { border: 1px solid var(--border); padding: 12px; text-align: left; }
        th { background-color: var(--panel2); font-weight: 600; }
        
        .quiz-item { margin-top: 1rem; padding: 1rem; background: var(--panel2); border-radius: 8px; }
        .quiz-option { margin: 0.5rem 0; }
        
        .chip{
            display:inline-block; padding: 2px 8px; border-radius: 999px;
            font-size: 12px; line-height: 1.6; margin-right: 6px;
            color: var(--badge-text); background: var(--badge-bg); border: 1px solid var(--badge-border);
        }
        /* ä¿æŒCEFRé¢œè‰² */
        .chip.cefr-B1{background:#eef2ff;border-color:#c7d2fe;color:#4338ca;}
        .chip.cefr-B2{background:#e0f2fe;border-color:#bae6fd;color:#0369a1;}
        .chip.cefr-C1{background:#f0fdf4;border-color:#bbf7d0;color:#15803d;}
        .chip.cefr-C2{background:#fefce8;border-color:#fde047;color:#854d0e;}
        @media (prefers-color-scheme: dark) {
            .chip.cefr-B1{background:#3730a3;border-color:#4f46e5;color:#e0e7ff;}
            .chip.cefr-B2{background:#0c4a6e;border-color:#0ea5e9;color:#e0f2fe;}
            .chip.cefr-C1{background:#166534;border-color:#22c55e;color:#dcfce7;}
            .chip.cefr-C2{background:#713f12;border-color:#eab308;color:#fefce8;}
        }

        /* æ‹–æ‹½å ä½ */
        .sortable-ghost { 
            opacity: 0.4; 
            background: var(--hl); 
            border: 2px dashed var(--accent);
            border-radius: var(--radius);
        }
        .card-draggable { cursor: grab; }
        .card-draggable:active { cursor: grabbing; }

        /* æ€»è¡¨æ ·å¼ */
        #summary-container .card {
             background: var(--panel);
        }
        #summary-container .section-title {
            padding: 10px 0;
            color: var(--text);
        }
        #summary-container details > summary {
            background: var(--panel);
        }
        #summary-container details[open] > summary {
             background: var(--panel);
        }
        #summary-container .details-content {
            padding: 0;
            border-top: none;
        }
        #summary-container table {
            margin-top: 0;
            border: none;
        }
         #summary-container th, #summary-container td {
            border-color: var(--border);
         }
         #summary-container th {
            background-color: var(--panel2);
            color: var(--text);
         }
         #summary-container tr:nth-child(even) {
            background-color: var(--panel2);
         }
         #summary-container tr:nth-child(odd) {
            background-color: var(--panel);
         }


        /* æ‰“å°æ ·å¼ */
        @media print{
            body{ background:#fff; font-size: 10pt; color: #000; }
            header { display: none !important; }
            .card{ box-shadow:none; border:1px solid #dee2e6; page-break-inside: avoid; background: #fff; }
            details{ border:none; }
            details[open] { page-break-inside: avoid; }
            summary::before { display: none; }
            .pron-btn, footer, script, #summary-container { display:none !important; }
            #vocab-container { display: block; } 
            body[data-layout="grid"] #vocab-container { display: block; }
            #vocab-container .card { width: 100% !important; }
            h1, h2, h3 { font-size: 1.2em; color: #000; }
            a { text-decoration: none; color: black; }
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000; opacity: 0; transition: opacity .2s; pointer-events: none;
        }
        .modal-overlay[data-visible="true"] { opacity: 1; pointer-events: auto; }
        .modal-content {
            background: var(--panel); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 24px 30px;
            max-width: 400px; width: 90%;
            box-shadow: 0 10px 30px var(--shadow);
            transform: scale(0.95); transition: transform .2s;
        }
        .modal-overlay[data-visible="true"] .modal-content { transform: scale(1); }
        .modal-content h3 { margin-top: 0; color: var(--accent); }
        .modal-content p { color: var(--text); }
        .modal-content #closeErrorModal { 
            margin-top: 20px; 
            background: var(--accent); 
            color: var(--bg); 
            border-color: var(--accent); 
            width: 100%;
            padding: 10px;
            font-weight: 700;
            border-radius: 8px;
            cursor: pointer;
        }
        .modal-content #closeErrorModal:hover { background: color-mix(in srgb, var(--accent) 80%, white); }
    
    /* --- æ ‘çŠ¶ç»“æ„ æ ·å¼ (ä»æ—§CSSè¿ç§»å¹¶é€‚é…) --- */
    /* æ ‘ç»“æ„ */
     .tree { --indent: 18px; }
     .node { position: relative; padding-left: 22px; border-left: 1px dashed #293244; margin-left: 10px; }
     .node::before { content: ""; position: absolute; left: -1px; top: 1.1em; width: 11px; border-top: 1px dashed #293244; }
     .node.root { border-left: none; padding-left: 0; margin-left: 0; }
     .row { display: flex; align-items: center; gap: 8px; padding: 6px 8px; margin: 1px 0; border-radius: 8px; }
     .row:hover { background: var(--panel2); }
     .toggle { width: 16px; height: 16px; line-height: 14px; text-align: center; border: 1px solid var(--toggle-border); border-radius: 4px; background: var(--toggle-bg); color: var(--toggle-text); cursor: pointer; user-select: none; flex-shrink: 0; }
     .toggle.leaf { opacity: .35; cursor: default; }
     .children { margin-left: 14px; padding-left: 8px; border-left: 1px dashed #2a3347; display: none; }
     .node.open > .children { display: block; }
     .node.open > .row .toggle:not(.leaf)::after { content: "â€“"; }
     .node > .row .toggle:not(.leaf)::after { content: "+"; }
     .node > .row .toggle.leaf::after { content: "Â·"; }
     .pill { font-size: 11px; padding: 2px 6px; border-radius: 6px; background: var(--pill-bg); border: 1px solid var(--pill-border); color: var(--pill-text); }
     mark { background: var(--hl); color: var(--accent); padding: 0 2px; border-radius: 4px; }
     code { background: var(--code-bg); border: 1px solid var(--code-border); padding: 1px 5px; border-radius: 6px; font-family: ui-monospace, "Cascadia Code", "Source Code Pro", Menlo, Consolas, "Liberation Mono", monospace; }

     /* å±æ€§åŒºåŸŸ (ä»æ—§CSSè¿ç§»å¹¶é€‚é…) */
     .meta-grid { display: grid; grid-template-columns: auto 1fr; gap: 10px 16px; align-items: baseline; }
     .meta-grid .k { grid-column: 1; font-size: 13px; color: var(--muted); text-align: right; font-weight: 600; }
     .meta-grid .v { grid-column: 2; word-break: break-word; background: var(--panel2); border: 1px solid var(--border); border-radius: 8px; padding: 6px 10px; }
     .badges { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 12px; }
     .badge { font-size: 12px; color: var(--badge-text); background: var(--badge-bg); border: 1px solid var(--badge-border); border-radius: 999px; padding: 2px 8px; }
     .tag { font-size: 12px; color: var(--tag-text); background: var(--tag-bg); border: 1px solid var(--tag-border); border-radius: 6px; padding: 2px 6px; }
     .muted { color: var(--muted); }

    /* å“åº”å¼ (ä»æ—§CSSè¿ç§»å¹¶é€‚é…) */
     @media (max-width: 560px) {
        :root { --colW: 92vw; }
        .meta-grid { grid-template-columns: 1fr; gap: 8px 0; }
        .meta-grid .k { grid-column: 1; text-align: left; font-size: 12px; margin-bottom: -6px; }
        .meta-grid .v { grid-column: 1; }
        .row { flex-wrap: wrap; }
        header .toolbar { grid-template-columns: 1fr; }
     }
</style>
</head>
<body data-layout="grid" data-density="cozy" data-drag="off">

<header>
  <div class="wrap">
    <h1>è¯æ ¹å®¶æ—æ ‘ Â· å¤šå±æ€§å¯è§†åŒ–</h1>
    <div class="toolbar">
      <!-- ç²˜è´´æŒ‰é’®ç§»åˆ°æœç´¢æ¡†å·¦ä¾§ -->
      <button class="btn" id="pasteData" title="ä»å‰ªè´´æ¿ç²˜è´´æ–°çš„è¯æ ¹æ•°æ®">ğŸ“‹ ç²˜è´´æ•°æ®</button>
      
      <input id="q" type="search" placeholder="ğŸ” æœç´¢æ‰€æœ‰è¯æ ¹å®¶æ—â€¦ (æ”¯æŒé«˜äº®)" aria-label="æœç´¢è¯æ ¹">
      
      <div class="tools" role="group" aria-label="è§†å›¾ä¸æ“ä½œ">
        <div class="seg" aria-label="å¸ƒå±€åˆ‡æ¢">
          <button class="btn" id="btnGrid" data-active="true" title="è‡ªé€‚åº”ç½‘æ ¼">ç½‘æ ¼</button>
          <button class="btn" id="btnScroll" title="æ¨ªå‘è½®æ’­">è½®æ’­</button>
        </div>
        <div class="seg" aria-label="å¯†åº¦åˆ‡æ¢">
          <button class="btn" id="btnCozy" data-active="true" title="èˆ’é€‚">èˆ’é€‚</button>
          <button class="btn" id="btnCompact" title="ç´§å‡‘">ç´§å‡‘</button>
        </div>
        <div class="slider" title="åˆ—å®½">
          <span class="hint">åˆ—å®½</span>
          <!-- æ›´æ–°é»˜è®¤å€¼ä¸º 384 -->
          <input id="colWidth" type="range" min="320" max="640" step="10" value="384" />
          <span id="colWidthVal" class="hint">384px</span>
        </div>

        <button class="btn" id="toggleDrag" title="æ‹–æ‹½é‡æ’ï¼ˆå¼€å¯åå¯æ‹–åŠ¨æ¯ä¸€åˆ—è¿›è¡Œæ’åºï¼‰">æ‹–æ‹½å…³</button>
        <button class="btn" id="expandAll" title="å±•å¼€å…¨éƒ¨">å…¨éƒ¨å±•å¼€</button>
        <button class="btn" id="collapseAll" title="æŠ˜å éæ ¹">å…¨éƒ¨æŠ˜å </button>
        <a href="https://flyingparanoia.github.io/Vocabulary/thesaurus.html" target="_blank" rel="noopener noreferrer" class="btn">
          ğŸ”€ è¿‘ä¹‰è¯æ¯”è¾ƒ
        </a>
        
      </div>
    </div>
  </div>
</header>

<!-- å®¹å™¨ ID æ›´æ–°ä¸º vocab-container -->
<main id="vocab-container" aria-live="polite"></main>

<!-- é”™è¯¯æç¤ºæ¨¡æ€æ¡† (æ›´æ–°ä¸º data-visible) -->
<div id="errorModal" class="modal-overlay" data-visible="false">
  <div class="modal-content">
    <h3 id="errorTitle">ç²˜è´´å¤±è´¥</h3>
    <p id="errorText"></p>
    <button id="closeErrorModal" class_="btn">å…³é—­</button> <!-- class_ just to avoid conflict, will be styled by ID -->
  </div>
</div>

<script>
/* =================== æ•°æ®æº =================== */
const allData = []; // é»˜è®¤æ¸…ç©ºï¼Œç­‰å¾…ç²˜è´´

/* =================== å·¥å…·å‡½æ•° =================== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
// JS å˜é‡æ›´æ–°
const vocabContainer = $("#vocab-container");

/* æ–°å¢ï¼šæ¨¡æ€æ¡†æ§åˆ¶å‡½æ•° (æ›´æ–°ä¸º data-visible) */
function showErrorModal(message, title = "æ“ä½œå¤±è´¥") {
  $('#errorTitle').textContent = title;
  $('#errorText').textContent = message;
  $('#errorModal').dataset.visible = 'true';
}
function hideErrorModal() {
  $('#errorModal').dataset.visible = 'false';
}

function el(tag, attrs = {}, ...kids) {
  const n = document.createElement(tag);
  Object.entries(attrs).forEach(([k, v]) => {
    if (k === "class") n.className = v;
    else if (k === "html") n.innerHTML = v;
    else if (k === "dataset") Object.assign(n.dataset, v);
    else n.setAttribute(k, v);
  });
  kids.forEach(k => n.append(k?.nodeType ? k : document.createTextNode(k)));
  return n;
}
function hl(t, q) { if (!q) return t; const s = q.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"); return t.replace(new RegExp(s, "gi"), m => `<mark>${m}</mark>`); }
function makeRow(title, right = [], leaf = false) {
  const t = el("div", { class: "toggle" + (leaf ? " leaf" : ""), role: leaf?"img":"button", tabindex: leaf?"-1":"0", "aria-label": leaf?"å¶èŠ‚ç‚¹":"å±•å¼€/æŠ˜å " });
  const row = el("div", { class: "row" }, t, el("div", { class: "title", html: title }), ...right);
  return { row, toggle: t };
}
function makeNode(content, children = []) {
  const node = el("div", { class: "node" });
  const kids = el("div", { class: "children" }, ...children);
  node.append(content, kids);
  return node;
}

/* =================== æ¸²æŸ“å‡½æ•° (é‡æ„) =================== */

function renderMeta(header, root, q = "") {
  // 1. æ¸²æŸ“å¡ç‰‡æ ‡é¢˜
  const title = el("h2", { class: "section-title", html: hl(root.key, q) + ` <span class="text-gray-500">ï¼ˆ${hl(root.base_meaning || "", q)}ï¼‰</span>` });
  header.append(title);
  
  // 2. æ¸²æŸ“å¯æŠ˜å çš„æ ¸å¿ƒå±æ€§
  const details = el("details", { class: "meta-details" });
  const summary = el("summary", {}, 
    "æ ¸å¿ƒå±æ€§ ", 
    el("span", {class: 'chip'}, `${Object.keys(root).filter(k=>k!=='key'&&k!=='base_meaning').length} é¡¹`)
  );
  
  const detailsContent = el("div", { class: "details-content" });
  const metaGrid = el("div", { class: "meta-grid" });
  
  const pairs = [
    ["æ¥æºè¯­è¨€", root.origin_language], ["éŸ³æ ‡", root.phonetic], ["è¡ç”Ÿå½¢å¼", (root.derived_forms || []).join(", ")],
    ["è¯­ä¹‰åœº", (root.semantic_field || []).join(", ")], ["åŒæºè¯æ ¹", (root.related_roots || []).join(", ")], ["å¯¹æ¯”è¯æ ¹", (root.contrast_roots || []).join(", ")],
    ["è¯æºè·¯å¾„", root.etymology_path], ["è®°å¿†è”æƒ³", root.mnemonic]
  ];
  pairs.forEach(([k, v]) => { if (v) { metaGrid.append(el("div", { class: "k" }, k)); metaGrid.append(el("div", { class: "v", html: hl(String(v), q) })); } });
  
  detailsContent.append(metaGrid);
  details.append(summary, detailsContent);
  header.append(details);
}

function renderTree(container, data, q = "") {
  // æ ‘çŠ¶ç»“æ„ç°åœ¨ç›´æ¥åœ¨ card-content ä¸­
  const rootTitle = `<strong>${hl(data.root.key, q)}</strong> <span class="muted">ï¼ˆ${hl(data.root.base_meaning || "", q)}ï¼‰</span>`;
  const { row: rootRow } = makeRow(rootTitle, [el("span", { class: "pill" }, "ROOT")]);
  const rootNode = makeNode(rootRow);
  rootNode.classList.add("root", "open"); // é»˜è®¤å±•å¼€æ ¹èŠ‚ç‚¹

  const childrenContainer = rootNode.querySelector(".children");

  // Only render trunk words section if data exists
  if (data.trunk_words && data.trunk_words.length > 0) {
    const trunkHead = makeRow("æ¯ä½“æ´¾ç”Ÿ", [el("span", { class: "badge" }, `${data.trunk_words.length} è¯`)]);
    const trunkChildren = data.trunk_words.map(x => makeNode(makeRow(`<code>${hl(x.w, q)}</code> <span class="muted">â€” ${hl(x.zh || "", q)}</span>`, [x.hint ? el("span", { class: "tag" }, x.hint) : ""], true).row));
    const trunkNode = makeNode(trunkHead.row, trunkChildren);
    trunkNode.classList.add("open"); // é»˜è®¤å±•å¼€
    childrenContainer.append(trunkNode);
  }

  // Only render variants section if data exists
  if (data.variants && data.variants.length > 0) {
    const variantHead = makeRow("å˜ä½“åˆ†æ”¯", [el("span", { class: "badge" }, `${data.variants.length} ç±»`)]);
    const variantChildren = data.variants.map(v => {
      const vRow = makeRow(`å˜ä½“ <strong>${hl(v.key, q)}</strong> <span class="muted">ï¼ˆ${hl(v.label || "", q)}ï¼‰</span>`, [el("span", { class: "badge" }, `${(v.words || []).length} è¯`)]);
      const wNodes = (v.words || []).map(w => makeNode(makeRow(`<code>${hl(w.w, q)}</code> <span class="muted">â€” ${hl(w.zh || "", q)}</span>`, [w.hint ? el("span", { class: "tag" }, w.hint) : ""], true).row));
      const vNode = makeNode(vRow.row, wNodes);
      vNode.classList.add("open"); // é»˜è®¤å±•å¼€
      return vNode;
    });
    const variantNode = makeNode(variantHead.row, variantChildren);
    variantNode.classList.add("open"); // é»˜è®¤å±•å¼€
    childrenContainer.append(variantNode);
  }

  container.append(rootNode);
}

function buildFamilyCard(data, q=""){
  // é‡æ„ä¸ºå•ä¸ªå¡ç‰‡
  const card = el('div', { 
    class: 'card card-draggable', 
    dataset: { key: data.root.key } 
  });

  // 1. åˆ›å»ºå¡ç‰‡å¤´éƒ¨
  const cardHeader = el('div', { class: 'card-header' });
  renderMeta(cardHeader, data.root, q);
  card.append(cardHeader);

  // 2. åˆ›å»ºå¡ç‰‡å†…å®¹ (æ ‘)
  const cardContent = el('div', { class: 'card-content' });
  const treeDiv = el('div', { class: 'tree' });
  renderTree(treeDiv, data, q);
  cardContent.append(treeDiv);
  card.append(cardContent);
  
  return card;
}

/* =================== äº¤äº’ & çŠ¶æ€ =================== */
const state = {
  layout: localStorage.getItem('layout') || 'grid',
  density: localStorage.getItem('density') || 'cozy',
  // æ›´æ–°é»˜è®¤å€¼ä¸º 384
  colW: parseInt(localStorage.getItem('colW') || '384', 10),
  drag: localStorage.getItem('drag') || 'off',
  order: JSON.parse(localStorage.getItem('order') || '[]'),
  query: localStorage.getItem('query') || ''
};

function applyStateToDOM(){
  document.body.dataset.layout = state.layout;
  document.body.dataset.density = state.density;
  document.body.dataset.drag = state.drag;
  document.documentElement.style.setProperty('--colW', state.colW + 'px');
  $('#colWidth').value = state.colW; $('#colWidthVal').textContent = state.colW + 'px';
  $('#q').value = state.query;
  $('#btnGrid').dataset.active = String(state.layout==='grid');
  $('#btnScroll').dataset.active = String(state.layout==='scroll');
  $('#btnCozy').dataset.active = String(state.density==='cozy');
  $('#btnCompact').dataset.active = String(state.density==='compact');
  $('#toggleDrag').textContent = state.drag==='on' ? 'æ‹–æ‹½å¼€' : 'æ‹–æ‹½å…³';
  
  // æ‹–æ‹½å±æ€§ç°åœ¨ç”± JS API å’Œ .card-draggable class æ§åˆ¶
  $$('.card').forEach(col => {
    col.draggable = state.drag === 'on';
  });
}

function persist(){
  localStorage.setItem('layout', state.layout);
  localStorage.setItem('density', state.density);
  localStorage.setItem('colW', String(state.colW));
  localStorage.setItem('drag', state.drag);
  localStorage.setItem('order', JSON.stringify(state.order));
  localStorage.setItem('query', state.query);
}

function reorderDataByState(data){
  if(!state.order.length) return data;
  const map = new Map(data.map((d,i)=>[d.root.key, d]));
  const ordered = [];
  state.order.forEach(k=>{ if(map.has(k)) { ordered.push(map.get(k)); map.delete(k);} });
  return ordered.concat(Array.from(map.values()));
}

function renderAll(q = "") {
  vocabContainer.innerHTML = ""; // ä½¿ç”¨æ–° ID
  const currentData = reorderDataByState(allData);
  currentData.forEach(d => vocabContainer.append(buildFamilyCard(d, q))); // ä½¿ç”¨æ–° ID
  applyStateToDOM(); // Ensure draggable state is applied after rendering
}

function expandAll(){ 
  $$('.node').forEach(n=>n.classList.add('open')); 
  $$('details').forEach(d=>d.open=true);
}
function collapseAll(){ 
  $$('.node:not(.root)').forEach(n=>n.classList.remove('open')); 
  $$('details').forEach(d=>d.open=false);
}

/* =================== æ‹–æ‹½åŠŸèƒ½ (æ›´æ–°) =================== */
function initDragAndDrop() {
    let placeholder = null;
    let dragging = null;

    vocabContainer.addEventListener('dragstart', e => {
        if (state.drag !== 'on') return;
        const target = e.target.closest('.card'); // ç›®æ ‡æ˜¯ .card
        if (!target) return;
        
        dragging = target;
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', target.dataset.key || '');

        setTimeout(() => {
            dragging.style.opacity = '0.5';
        }, 0);
        
        placeholder = document.createElement('div');
        // ä½¿ç”¨æ–° CSS å®šä¹‰çš„ ghost class
        placeholder.className = 'card sortable-ghost'; 
        placeholder.style.height = target.getBoundingClientRect().height + 'px';
        placeholder.style.width = getComputedStyle(target).width;
    });

    vocabContainer.addEventListener('dragover', e => {
        e.preventDefault();
        if (!dragging) return;
        // å¯»æ‰¾ .card, æ’é™¤ dragging è‡ªèº«å’Œ placeholder
        const after = [...vocabContainer.children].find(c => c !== dragging && !c.classList.contains('sortable-ghost') && e.clientX <= (c.getBoundingClientRect().left + c.getBoundingClientRect().width / 2));
        if (after) {
            vocabContainer.insertBefore(placeholder, after);
        } else {
            vocabContainer.appendChild(placeholder);
        }
    });

    vocabContainer.addEventListener('drop', e => {
        e.preventDefault();
        if (!dragging || !placeholder) return;
        vocabContainer.insertBefore(dragging, placeholder);
    });

    vocabContainer.addEventListener('dragend', e => {
        if (!dragging) return;
        dragging.style.opacity = '1';
        placeholder?.remove();
        placeholder = null;
        dragging = null;

        // æ›´æ–° state.order
        state.order = [...vocabContainer.querySelectorAll('.card:not(.sortable-ghost)')].map(n => n.dataset.key).filter(Boolean);
        persist();
    });
}

/* =================== äº‹ä»¶ç»‘å®š =================== */
function debounce(fn, wait=180){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); }; }

document.addEventListener('DOMContentLoaded', () => {
  renderAll(state.query);
  expandAll();
  initDragAndDrop(); // Initialize drag and drop listeners once

  // ç‚¹å‡»å±•å¼€/æŠ˜å  (æ ‘èŠ‚ç‚¹)
  vocabContainer.addEventListener('click', e => {
    const toggle = e.target.closest('.toggle');
    if (toggle && !toggle.classList.contains('leaf')) {
      toggle.closest('.node').classList.toggle('open');
    }
  });
  
  // é”®ç›˜å¯è®¿é—®æ€§ï¼ˆEnter / Spaceï¼‰(æ ‘èŠ‚ç‚¹)
  vocabContainer.addEventListener('keydown', e => {
    if((e.key==='Enter'||e.key===' ') && e.target.classList.contains('toggle')){
      e.preventDefault(); e.target.closest('.node').classList.toggle('open');
    }
  });

  // æœç´¢ï¼ˆå¸¦é˜²æŠ– & é«˜äº®ï¼‰
  $('#q').addEventListener('input', debounce(e => {
    state.query = e.target.value.trim();
    persist();
    renderAll(state.query);
    expandAll();
  }, 150));

  // å¸ƒå±€
  $('#btnGrid').addEventListener('click', ()=>{ state.layout='grid'; persist(); applyStateToDOM(); });
  $('#btnScroll').addEventListener('click', ()=>{ state.layout='scroll'; persist(); applyStateToDOM(); });

  // å¯†åº¦
  $('#btnCozy').addEventListener('click', ()=>{ state.density='cozy'; persist(); applyStateToDOM(); });
  $('#btnCompact').addEventListener('click', ()=>{ state.density='compact'; persist(); applyStateToDOM(); });

  // åˆ—å®½
  $('#colWidth').addEventListener('input', e=>{
    state.colW = parseInt(e.target.value,10);
    document.documentElement.style.setProperty('--colW', state.colW + 'px');
    $('#colWidthVal').textContent = state.colW + 'px';
  });
  $('#colWidth').addEventListener('change', ()=>{ persist(); });

  // æ‹–æ‹½å¼€å…³
  $('#toggleDrag').addEventListener('click', ()=>{
    state.drag = (state.drag==='on')?'off':'on';
    persist(); 
    applyStateToDOM();
  });

  // å±•å¼€/æŠ˜å 
  $('#expandAll').onclick = expandAll;
  $('#collapseAll').onclick = collapseAll;

  /* --- æ–°å¢äº‹ä»¶ --- */
  
  // æ¨¡æ€æ¡†å…³é—­
  $('#closeErrorModal').addEventListener('click', hideErrorModal);
  $('#errorModal').addEventListener('click', e => {
    // ç‚¹å‡»èƒŒæ™¯å…³é—­
    if (e.target === $('#errorModal')) hideErrorModal();
  });

  // ç²˜è´´æŒ‰é’®ç‚¹å‡»
  $('#pasteData').addEventListener('click', async () => {
    try {
      const text = await navigator.clipboard.readText();
      if (!text || text.trim().length === 0) {
        showErrorModal("å‰ªè´´æ¿ä¸ºç©ºã€‚", "ç²˜è´´æç¤º");
        return;
      }

      let parsedData;
      try {
        // ä½¿ç”¨ Function æ„é€ å‡½æ•°æ¥è§£æ JS å¯¹è±¡å­—é¢é‡
        // è¿™æ˜¯ä¸ºäº†å¤„ç†ç”¨æˆ·ç¤ºä¾‹ä¸­å¸¦æ³¨é‡Šå’Œéæ ‡å‡† JSON çš„æ ¼å¼
        const cleanText = text.replace(/\/\/.*$/gm, '').trim(); // ç§»é™¤è¡Œæ³¨é‡Šå¹¶å»é™¤é¦–å°¾ç©ºæ ¼
        let evalText = cleanText;
        if (!cleanText.startsWith('[')) {
            // å¦‚æœç²˜è´´çš„æ–‡æœ¬ä¸æ˜¯ä»¥ [ å¼€å¤´ï¼ˆä¾‹å¦‚åªæ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªJSå¯¹è±¡ï¼‰ï¼Œåˆ™åŒ…è£¹å®ƒ
            evalText = '[' + cleanText + ']';
        }
        parsedData = new Function("return " + evalText)();
      } catch (parseErr) {
        console.error("Parsing error:", parseErr);
        throw new Error("è§£ææ•°æ®å¤±è´¥ã€‚è¯·ç¡®ä¿ç²˜è´´çš„å†…å®¹æ˜¯æœ‰æ•ˆçš„ JavaScript å¯¹è±¡æ•°ç»„æ ¼å¼ï¼ˆå¦‚ç¤ºä¾‹æ•°æ®ï¼‰ã€‚");
      }

      if (!Array.isArray(parsedData) || parsedData.length === 0) {
        throw new Error("æ•°æ®æ ¼å¼æ— æ•ˆã€‚éœ€è¦ä¸€ä¸ªåŒ…å«è¯æ ¹å¯¹è±¡çš„æ•°ç»„ã€‚");
      }
      
      // ç®€å•éªŒè¯æ•°æ®ç»“æ„
      if (!parsedData[0].root || !parsedData[0].root.key) {
         throw new Error("æ•°æ®ç»“æ„ä¸åŒ¹é…ã€‚ç¼ºå°‘ 'root.key' å­—æ®µã€‚");
      }

      // æˆåŠŸè§£æï¼Œæ›¿æ¢ç°æœ‰æ•°æ®
      allData.length = 0; // æ¸…ç©ºåŸæ•°ç»„
      Array.prototype.push.apply(allData, parsedData); // æ·»åŠ æ–°æ•°æ®
      
      // é‡ç½®é¡ºåºå¹¶é‡ç»˜
      state.order = allData.map(d => d.root.key);
      persist();
      renderAll(state.query);
      expandAll();

    } catch (err) {
      showErrorModal(err.message || "ç²˜è´´æ—¶å‘ç”ŸæœªçŸ¥é”™è¯¯ã€‚", "ç²˜è´´å¤±è´¥");
    }
  });
});
</script>
</body>
</html>
